---
import VisitorTracker from '../components/VisitorTracker.astro';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "My Personal Website with 3D Models" } = Astro.props;

// Read version from version.json
import versionData from '../../version.json';
const siteVersion = versionData.version;

// Read build info from build-info.json (generated by GitHub Actions)
let buildDate = '0000-00-00';
let buildTime = '00:00:00';

try {
  const buildInfo = await import('../../build-info.json');
  buildDate = buildInfo.default?.buildDate || buildInfo.buildDate || buildDate;
  buildTime = buildInfo.default?.buildTime || buildInfo.buildTime || buildTime;
} catch (error) {
  console.warn('build-info.json not found, using placeholder values');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title}</title>
  <!-- KaTeX CSS for Math Rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
  <!-- Mermaid JS for Diagrams -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      securityLevel: 'loose',
      themeVariables: {
        darkMode: true,
        background: '#0b1015',
        primaryColor: '#161f29',
        primaryTextColor: '#e4e7ed',
        primaryBorderColor: '#2a3542',
        lineColor: '#62c7ff',
        secondaryColor: '#101820',
        tertiaryColor: '#161f29',
        textColor: '#9ea7b3',
        mainBkgColor: '#161f29',
        secondBkgColor: '#101820',
        tertiaryBkgColor: '#0b1015',
        noteBkgColor: '#2a3542',
        noteTextColor: '#e4e7ed',
        noteBorderColor: '#f5a524',
      }
    });
    // Make mermaid available globally for components
    window.mermaid = mermaid;
  </script>
  <style is:global>
    /* Google Fonts - JetBrains Mono */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');

    :root {
      /* Engineering / Industrial palette */
      --bg-primary: #0b1015;      /* coal */
      --bg-secondary: #101820;    /* steel */
      --bg-tertiary: #161f29;     /* dark panel */
      --panel-glow: rgba(255, 165, 36, 0.08);

      --text-primary: #e4e7ed;
      --text-secondary: #9ea7b3;
      --text-muted: #5f6b78;

      --accent-primary: #f5a524;  /* hazard amber */
      --accent-secondary: #62c7ff;/* blueprint cyan */
      --accent-emerald: #4ade80;  /* system healthy */

      --border-strong: #2a3542;
      --border-light: #1c252f;

      --font-mono: 'JetBrains Mono', monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-mono);
      line-height: 1.6;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      background-image:
        radial-gradient(circle at 20% 20%, rgba(98, 199, 255, 0.06), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(245, 165, 36, 0.08), transparent 30%),
        repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 32px),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.04) 1px, transparent 1px, transparent 32px);
      background-size: 100% 100%, 100% 100%, 64px 64px, 64px 64px;
      min-height: 100vh;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-strong);
      border: 2px solid var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    nav {
      background: linear-gradient(180deg, #111923 0%, #0c141c 100%);
      border-bottom: 2px solid var(--accent-primary);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
    }

    nav ul {
      list-style: none;
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0;
    }

    .menu-toggle {
      display: none;
      background: transparent;
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 0.45rem 0.6rem;
      cursor: pointer;
      gap: 0.3rem;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 4px;
    }

    .menu-toggle span {
      display: block;
      width: 18px;
      height: 2px;
      background: var(--text-primary);
    }

    nav li {
      border-left: 1px solid var(--border-light);
    }

    nav li:first-child {
      border-left: none;
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.15s ease;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      display: block;
      padding: 1rem 1.75rem;
      position: relative;
    }
    nav a::after {
      content: '';
      position: absolute;
      left: 1.2rem;
      right: 1.2rem;
      bottom: 0.6rem;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 8px rgba(245, 165, 36, 0.4);
    }

    nav a:hover,
    nav a:focus {
      color: var(--accent-primary);
      background: rgba(245, 165, 36, 0.06);
    }

    nav a:hover::after,
    nav a:focus::after {
      transform: scaleX(1);
    }

    main {
      max-width: 1350px;
      margin: 2rem auto 3rem;
      padding: 0 2rem;
    }

    .container {
      background: linear-gradient(135deg, rgba(26, 33, 42, 0.92), rgba(16, 24, 32, 0.92));
      border: 1px solid var(--border-strong);
      padding: 2.25rem;
      position: relative;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.04),
        0 18px 36px rgba(0, 0, 0, 0.35);
      overflow: hidden;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
    }

    .container::before,
    .container::after {
      content: "";
      position: absolute;
      border: 1px solid var(--accent-primary);
      opacity: 0.45;
      pointer-events: none; /* keep overlays from blocking clicks */
    }

    .container::before {
      inset: 12px;
      border-style: dashed;
      border-width: 1px;
    }

    .container::after {
      width: 42px;
      height: 42px;
      top: -1px;
      left: -1px;
      border-right: none;
      border-bottom: none;
      background: linear-gradient(135deg, var(--panel-glow) 0%, transparent 70%);
    }

    h1 {
      color: var(--accent-primary);
      margin-bottom: 1rem;
      font-size: 2.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-strong);
      padding-bottom: 0.75rem;
    }

    h2 {
      color: var(--text-primary);
      margin-top: 2rem;
      margin-bottom: 1rem;
      text-transform: uppercase;
      font-size: 1.35rem;
      display: flex;
      flex-wrap: wrap; /* allow natural word wrapping */
      align-items: baseline;
      gap: 0.6rem 0.45rem;
      letter-spacing: 1px;
    }

    h2::before {
      content: "///";
      color: var(--accent-secondary);
      font-weight: 700;
      flex-shrink: 0;
      white-space: nowrap; /* keep slashes on the same line */
    }

    p {
      margin-bottom: 1rem;
      color: var(--text-secondary);
    }

    code {
      background: var(--bg-tertiary);
      color: var(--accent-secondary);
      padding: 0.25rem 0.45rem;
      border: 1px solid var(--border-strong);
      font-family: var(--font-mono);
      border-radius: 2px;
    }

    pre {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 1rem;
      border: 1px solid var(--border-strong);
      margin: 1rem 0;
      border-left: 3px solid var(--accent-primary);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      overflow-x: auto;
      white-space: pre;
      word-break: normal;
      overflow-wrap: normal;
      opacity: 0;
      transform: translateX(-10px);
      transition: all 0.5s ease-out;
    }

    pre.code-visible {
      opacity: 1;
      transform: translateX(0);
      border-left-color: var(--accent-primary);
      box-shadow: 
        inset 0 0 0 1px rgba(255, 255, 255, 0.02),
        0 0 12px rgba(245, 165, 36, 0.15);
    }

    /* Neutralize per-line shading from syntax highlighters */
    pre code {
      background: transparent !important;
      box-shadow: none !important;
      white-space: inherit;
      word-break: normal;
      overflow-wrap: normal;
    }
    pre code span {
      background: transparent !important;
    }
    /* Removed custom dual-scrollbars; rely on native bottom scrollbar */

    /* Allow long math equations to scroll horizontally */
    .katex-display {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      padding-bottom: 0.25rem;
      white-space: nowrap; /* keep long equations on a single line */
      min-width: 0; /* allow scroll container to shrink */
    }
    .katex-display > .katex {
      display: inline-block;
      padding: 0.25rem 0;
      white-space: nowrap;
      min-width: max-content; /* prevent inner wrap so scrolling works */
      line-height: 1.2;
    }
    /* Ensure KaTeX fragments don't wrap individually */
    .katex-display .katex * {
      white-space: nowrap;
    }
    /* Equation tags beneath formulas */
    .equation-tag {
      text-align: right;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin: 0.2rem 0 0.6rem;
    }

    @media (max-width: 520px) {
      .katex-display {
        font-size: 0.9rem; /* slight downscale for narrow screens */
      }
    }

    blockquote {
      border-left: 4px solid var(--accent-secondary);
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      background: rgba(22, 31, 41, 0.85);
      color: var(--text-primary);
    }

    /* Callouts */
    .callout {
      border: 1px solid var(--border-strong);
      border-left: 4px solid var(--accent-primary);
      background: rgba(22, 31, 41, 0.92);
      padding: 1rem 1.25rem;
      margin: 1.25rem 0;
      position: relative;
    }
    .callout::before {
      content: attr(data-callout);
      text-transform: uppercase;
      font-weight: 700;
      color: var(--accent-primary);
      display: block;
      margin-bottom: 0.35rem;
      letter-spacing: 0.6px;
      font-size: 0.9rem;
    }
    .callout-hint { border-left-color: var(--accent-secondary); }
    .callout-info { border-left-color: var(--accent-secondary); }
    .callout-error { border-left-color: #e1695d; }
    .callout-warn { border-left-color: #f5a524; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      border: 1px solid var(--border-strong);
      background: var(--bg-tertiary);
    }

    table thead {
      background: rgba(16, 24, 32, 0.9);
      color: var(--accent-primary);
      text-transform: uppercase;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    table th,
    table td {
      padding: 0.75rem;
      text-align: left;
      border: 1px solid var(--border-strong);
      color: var(--text-secondary);
    }

    table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    table tbody tr:hover {
      background: rgba(245, 165, 36, 0.08);
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    ul li {
      margin: 0.6rem 0;
      padding-left: 1.6rem;
      position: relative;
      color: var(--text-secondary);
    }

    ul li::before {
      content: "#";
      position: absolute;
      left: 0;
      color: var(--accent-primary);
      font-weight: 800;
    }

    ol {
      list-style: none;
      padding-left: 0;
      counter-reset: item;
    }

    ol li {
      margin: 0.6rem 0;
      padding-left: 2rem;
      position: relative;
      color: var(--text-secondary);
      counter-increment: item;
    }

    ol li::before {
      content: counter(item) ".";
      position: absolute;
      left: 0;
      color: var(--accent-primary);
      font-weight: 700;
      font-family: var(--font-mono);
    }

    a {
      color: var(--accent-secondary);
      text-decoration: none;
      transition: color 0.15s;
    }

    a:hover {
      color: var(--accent-primary);
      text-decoration: underline;
    }

    img {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--border-strong);
      margin: 1.5rem 0;
      filter: grayscale(10%);
      transition: all 0.25s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    img:hover {
      filter: grayscale(0%);
      border-color: var(--accent-primary);
      box-shadow: 0 14px 38px rgba(0, 0, 0, 0.45);
    }

    .scroll-progress {
      position: fixed;
      right: 1.4rem;
      bottom: 1.4rem;
      padding: 0.35rem 0.65rem;
      background: rgba(12, 20, 28, 0.9);
      border: 1px solid var(--border-strong);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.04),
        0 8px 18px rgba(0, 0, 0, 0.35);
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 120;
    }

    /* Site Info Button */
    .site-info-btn {
      position: fixed;
      top: 1rem;
      right: 1.4rem;
      width: 32px;
      height: 32px;
      background: rgba(12, 20, 28, 0.9);
      border: 1px solid var(--border-strong);
      border-radius: 50%;
      color: var(--accent-secondary);
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 120;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.04),
        0 4px 12px rgba(0, 0, 0, 0.25);
    }

    .site-info-btn:hover {
      background: rgba(98, 199, 255, 0.15);
      border-color: var(--accent-secondary);
      transform: scale(1.1);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.04),
        0 6px 16px rgba(98, 199, 255, 0.3);
    }

    /* Site Info Modal */
    .site-info-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
    }

    .site-info-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(11, 16, 21, 0.85);
      backdrop-filter: blur(4px);
    }

    .site-info-content {
      position: relative;
      max-width: 500px;
      margin: 10vh auto;
      background: linear-gradient(135deg, rgba(26, 33, 42, 0.98), rgba(16, 24, 32, 0.98));
      border: 1px solid var(--border-strong);
      border-radius: 8px;
      padding: 2rem;
      max-height: 80vh;
      overflow-y: auto;
      overflow-x: visible;
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.04),
        0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .site-info-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      font-size: 1.8rem;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      cursor: pointer;
      line-height: 1;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .site-info-close:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(245, 165, 36, 0.1);
    }

    .site-info-content h3 {
      margin: 0 0 1.5rem 0;
      color: var(--accent-primary);
      font-size: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid var(--border-strong);
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .site-info-content h3::before {
      content: "///";
      color: var(--accent-secondary);
      font-weight: 700;
      flex-shrink: 0;
    }

    .info-section {
      margin-bottom: 1.5rem;
      overflow: visible;
    }

    .info-section h4 {
      color: var(--accent-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 0.5rem 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .info-section h4::before {
      content: "///";
      color: var(--accent-secondary);
      font-weight: 700;
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .info-section p {
      margin: 0.25rem 0;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    .info-detail {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .tech-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tech-list li {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: 0.25rem 0;
      border-left: 2px solid var(--border-light);
      padding-left: 0.75rem;
      margin: 0.25rem 0;
    }

    .tech-list li::before {
      content: none;
    }

    .tech-list strong {
      color: var(--text-primary);
    }

    .tech-list .license {
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    .bug-report-link,
    .repo-link {
      color: var(--accent-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
      font-family: var(--font-mono);
    }

    .bug-report-link:hover,
    .repo-link:hover {
      color: var(--accent-primary);
      text-decoration: underline;
    }

    .stat-item {
      position: relative;
      overflow: visible;
    }

    #stats-content {
      overflow: visible;
    }

    .stat-label-tooltip {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      cursor: help;
      position: relative;
      display: inline-block;
    }

    .stat-label-tooltip {
      position: relative;
    }

    .stat-label-tooltip::after {
      content: attr(data-tooltip);
      position: fixed;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      border: 1px solid var(--border-strong);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      width: 400px;
      max-width: calc(90vw - 2rem);
      white-space: normal;
      text-align: left;
      line-height: 1.5;
      font-weight: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
      left: var(--tooltip-left, 0);
      top: var(--tooltip-top, 0);
      transform: translateX(-50%) translateY(-100%) translateY(-8px);
    }

    .stat-label-tooltip::before {
      content: '';
      position: fixed;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid var(--bg-primary);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10002;
      left: var(--tooltip-left, 0);
      top: var(--tooltip-top, 0);
      transform: translateX(-50%) translateY(-2px);
    }

    .stat-label-tooltip:hover::after,
    .stat-label-tooltip:hover::before {
      opacity: 1;
    }

    /* Creative animation for statistics link */
    .stats-link-creative {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, rgba(98, 199, 255, 0.03) 0%, rgba(245, 165, 36, 0.03) 100%);
      border: 1px solid transparent;
    }

    .stats-link-creative::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(98, 199, 255, 0.15), transparent);
      animation: shimmer-sweep 3s ease-in-out infinite;
    }

    .stats-link-creative::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary), var(--accent-secondary));
      opacity: 0;
      z-index: -1;
      filter: blur(8px);
      transition: opacity 0.4s ease;
    }

    .stats-link-text {
      position: relative;
      z-index: 1;
      background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary), var(--accent-secondary));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 3s ease infinite;
      opacity: 0.9;
    }

    .stats-link-arrow {
      position: relative;
      z-index: 1;
      display: inline-block;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      animation: arrow-pulse 2s ease-in-out infinite;
    }

    .stats-link-creative:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(98, 199, 255, 0.15);
      border-color: var(--accent-secondary);
    }

    .stats-link-creative:hover::after {
      opacity: 0.3;
    }

    .stats-link-creative:hover .stats-link-arrow {
      transform: translateX(4px) rotate(15deg) scale(1.2);
      animation: arrow-bounce 0.6s ease infinite;
    }

    .stats-link-creative:hover .stats-link-text {
      animation: gradient-shift 1s ease infinite;
    }

    @keyframes shimmer-sweep {
      0% {
        left: -100%;
      }
      50% {
        left: 100%;
      }
      100% {
        left: 100%;
      }
    }

    @keyframes gradient-shift {
      0%, 100% {
        background-position: 0% center;
      }
      50% {
        background-position: 100% center;
      }
    }

    @keyframes arrow-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    @keyframes arrow-bounce {
      0%, 100% {
        transform: translateX(4px) rotate(15deg) scale(1.2);
      }
      50% {
        transform: translateX(8px) rotate(20deg) scale(1.3);
      }
    }

    @media (max-width: 768px) {
      .menu-toggle {
        display: inline-flex;
        margin: 0.5rem;
      }

      nav {
        padding: 0.5rem 0.25rem;
      }

      nav ul {
        flex-direction: column;
        width: 100%;
        display: none;
      }

      nav li {
        border-left: none;
        border-top: 1px solid var(--border-light);
        width: 100%;
      }

      nav a {
        padding: 0.65rem 1rem;
        font-size: 0.82rem;
        letter-spacing: 0.8px;
        text-align: center;
        line-height: 1.3;
        width: 100%;
      }

      nav.nav-links.open ul {
        display: flex;
      }

      main {
        padding: 0 1rem;
        max-width: 100%;
      }

      .container {
        padding: 1.5rem;
        max-width: 100%;
      }

      h1 {
        font-size: 1.85rem;
      }

      h2 {
        font-size: 1.1rem;
        letter-spacing: 0.6px;
        gap: 0.5rem 0.35rem;
      }

      body {
        background-size: 120px 120px, 120px 120px, 48px 48px, 48px 48px;
      }

      .scroll-progress {
        right: 1rem;
        bottom: 1rem;
        font-size: 0.8rem;
      }

      .site-info-btn {
        top: 0.8rem;
        right: 1rem;
        width: 28px;
        height: 28px;
        font-size: 1rem;
      }

      .site-info-content {
        margin: 5vh 1rem;
        padding: 1.5rem;
        max-height: 85vh;
      }

      .site-info-content h3 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
      <nav class="nav-links">
        <button class="menu-toggle" aria-expanded="false" aria-label="Toggle menu">
          <span></span><span></span><span></span>
        </button>
        <ul>
          <li><a href="/" class="nav-link">Home</a></li>
          <li><a href="/career" class="nav-link">Career &amp; Experience</a></li>
          <li><a href="/projects" class="nav-link">Personal Projects</a></li>
          <li><a href="/notes" class="nav-link">Notes</a></li>
          <li><a href="/engineering" class="nav-link">Engineering</a></li>
        </ul>
      </nav>
  <main>
    <slot />
  </main>
  <VisitorTracker />
  <div id="scroll-progress" class="scroll-progress" aria-hidden="true">0%</div>
  
  <!-- Site Info Button -->
  <button id="site-info-btn" class="site-info-btn" aria-label="Site Information" title="Site Information">
    <span>!</span>
  </button>
  
  <!-- Site Info Modal -->
  <div id="site-info-modal" class="site-info-modal" style="display: none;">
    <div class="site-info-overlay"></div>
    <div class="site-info-content">
      <button class="site-info-close" aria-label="Close">&times;</button>
      <h3>Site Information</h3>
      <div class="info-section">
        <h4>Author and Maintainer</h4>
        <p>Ahmed N. Alfahdi</p>
      </div>
      <div class="info-section">
        <h4>Version</h4>
        <p>{siteVersion}</p>
      </div>
      <div class="info-section">
        <h4>Last Build</h4>
        <p>{buildDate} at {buildTime} UTC</p>
        <p class="info-detail">Static site generated with Astro</p>
      </div>
      <div class="info-section">
        <h4>Source Control</h4>
        <p><a href="https://github.com/AhmedAlfahdi/ahmedalfahdi.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">View on GitHub</a></p>
        <p class="info-detail">Branch: main</p>
      </div>
      <div class="info-section">
        <h4>Built With</h4>
        <ul class="tech-list">
          <li><strong>Astro</strong> 5.16.0 <span class="license">(MIT)</span></li>
          <li><strong>Three.js</strong> 0.159.0 <span class="license">(MIT)</span></li>
          <li><strong>KaTeX</strong> 0.16.25 <span class="license">(MIT)</span></li>
          <li><strong>Mermaid</strong> 10.9.5 <span class="license">(MIT)</span></li>
          <li><strong>PDF.js</strong> 5.4.394 <span class="license">(Apache 2.0)</span></li>
          <li><strong>MapLibre GL JS</strong> 3.6.1 <span class="license">(BSD 2-Clause)</span></li>
          <li><strong>Vercel</strong> <span class="license">(Analytics API)</span></li>
        </ul>
      </div>
      <div class="info-section">
        <h4>Report Bugs</h4>
        <p><a href="https://github.com/AhmedAlfahdi/ahmedalfahdi.github.io/issues" target="_blank" rel="noopener noreferrer" class="bug-report-link">Submit an issue on GitHub</a></p>
      </div>
      <div class="info-section">
        <h4>Website Statistics</h4>
        <div id="stats-loading" style="padding: 0.5rem 0; color: var(--text-muted); font-size: 0.9rem;">Loading...</div>
        <div id="stats-error" style="display: none; padding: 0.5rem 0; color: #e1695d; font-size: 0.9rem;">Unable to load statistics</div>
        <div id="stats-content" style="display: none;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
            <div class="stat-item">
              <div class="stat-label-tooltip" data-tooltip="Total number of page views across all pages on your website.">Total Views</div>
              <div style="color: var(--accent-primary); font-weight: 600; font-family: var(--font-mono);" id="total-views">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-tooltip" data-tooltip="Network-level count: Number of unique IP addresses that visited your site. Multiple people behind the same IP (corporate network, NAT) count as one IP.">Distinct IPs</div>
              <div style="color: var(--accent-primary); font-weight: 600; font-family: var(--font-mono);" id="distinct-ips">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-tooltip" data-tooltip="Browser-level count: Number of unique visitors tracked by browser ID. More accurate than IPs as it identifies actual people, not just network addresses.">Unique Visitors</div>
              <div style="color: var(--accent-primary); font-weight: 600; font-family: var(--font-mono);" id="unique-visitors">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-tooltip" data-tooltip="The most visited page on your website based on total page views.">Top Page</div>
              <div style="color: var(--accent-secondary); font-size: 0.85rem; font-family: var(--font-mono); word-break: break-all;" id="top-page">-</div>
            </div>
          </div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light); text-align: center;">
            <a href="/statistics" class="stats-link-creative" style="color: var(--accent-secondary); text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem; position: relative; padding: 0.5rem 1rem; border-radius: 4px; transition: all 0.3s ease;">
              <span class="stats-link-text">View detailed statistics</span>
              <span class="stats-link-arrow">â†’</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
  if (typeof window !== 'undefined') {
    const nav = document.querySelector('nav.nav-links');
    const toggle = nav?.querySelector('.menu-toggle');
    toggle?.addEventListener('click', () => {
      nav.classList.toggle('open');
      const expanded = nav.classList.contains('open');
      toggle.setAttribute('aria-expanded', expanded.toString());
    });

    // Lightweight callout parsing for Obsidian-style [!tag] blocks
    document.querySelectorAll('blockquote').forEach((block) => {
      const first = block.firstElementChild;
      if (!first || first.tagName !== 'P') return;
      const textNode = first.firstChild;
      if (!textNode || textNode.nodeType !== Node.TEXT_NODE) return;
      const m = textNode.textContent?.trim().match(/^\[\!(\w+)\]\s*(.*)$/);
      if (!m) return;
      const tag = m[1].toLowerCase();
      const rest = m[2] || '';
      textNode.textContent = rest ? `${rest} ` : '';
      block.classList.add('callout', `callout-${tag}`);
      block.setAttribute('data-callout', tag);
    });

    // Add a tooltip for horizontal scrolling on overflowed code/tables
    const addScrollTips = () => {
      document.querySelectorAll('pre, table').forEach((el) => {
        if (el.scrollWidth > el.clientWidth + 1) {
          el.setAttribute('title', 'Tip: hold Shift + mouse wheel to scroll horizontally');
        } else {
          el.removeAttribute('title');
        }
      });
    };

    addScrollTips();
    window.addEventListener('resize', addScrollTips);
    window.setTimeout(addScrollTips, 300);
    window.addEventListener('load', addScrollTips);

    // Scroll progress indicator for long MDX pages
    const progressEl = document.getElementById('scroll-progress');
    const updateProgress = () => {
      if (!progressEl) return;
      const doc = document.documentElement;
      const scrollTop = window.scrollY || doc.scrollTop || 0;
      const scrollable = Math.max(doc.scrollHeight - doc.clientHeight, 0);
      const percent = scrollable > 0 ? Math.min(100, Math.max(0, (scrollTop / scrollable) * 100)) : 100;
      progressEl.textContent = `${Math.round(percent)}%`;
      progressEl.style.opacity = scrollable > 0 ? '1' : '0';
    };
    updateProgress();
    window.addEventListener('scroll', updateProgress, { passive: true });
    window.addEventListener('resize', updateProgress);
    window.addEventListener('load', updateProgress);

    // Animate code blocks on scroll
    const codeBlocks = document.querySelectorAll('pre');
    if (codeBlocks.length > 0) {
      const codeObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('code-visible');
            codeObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

      codeBlocks.forEach(block => codeObserver.observe(block));
    }

    // Site info modal functionality
    const infoBtn = document.getElementById('site-info-btn');
    const infoModal = document.getElementById('site-info-modal');
    const infoClose = document.querySelector('.site-info-close');
    const infoOverlay = document.querySelector('.site-info-overlay');

    if (infoBtn && infoModal) {
      const closeModal = () => {
        infoModal.style.display = 'none';
        document.body.style.overflow = '';
      };

      if (infoClose) {
        infoClose.addEventListener('click', closeModal);
      }

      if (infoOverlay) {
        infoOverlay.addEventListener('click', closeModal);
      }

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && infoModal.style.display === 'block') {
          closeModal();
        }
      });

      // Load statistics when modal opens
      let modalRetryCount = 0;
      let currentRequestController = null;
      const MODAL_MAX_RETRIES = 1; // Reduced to 1 retry for faster failure
      const MODAL_RETRY_DELAY = 2000;
      const MODAL_TIMEOUT = 5000; // 5 second timeout (shorter)
      
      const loadStats = async (isRetry = false) => {
        const API_BASE = import.meta.env.PUBLIC_ANALYTICS_API || 'https://analytics-api-one.vercel.app/api';
        const API_ENDPOINT = `${API_BASE}/stats`;
        const loadingEl = document.getElementById('stats-loading');
        const errorEl = document.getElementById('stats-error');
        const contentEl = document.getElementById('stats-content');
        
        if (!loadingEl || !errorEl || !contentEl) return;
        
        // Cancel any previous request
        if (currentRequestController) {
          currentRequestController.abort();
          currentRequestController = null;
        }
        
        // Show retry message if this is a retry
        if (isRetry && modalRetryCount > 0) {
          loadingEl.textContent = `Retrying... (${modalRetryCount}/${MODAL_MAX_RETRIES})`;
        } else {
          loadingEl.textContent = 'Loading...';
        }
        
        let requestInProgress = true;
        let timeoutFired = false;
        let apiTimeout;
        
        // Fallback timeout (shorter)
        const showTimeoutError = () => {
          if (!requestInProgress || timeoutFired) return;
          timeoutFired = true;
          requestInProgress = false;
          
          // Abort the request
          if (currentRequestController) {
            currentRequestController.abort();
            currentRequestController = null;
          }
          
          if (modalRetryCount < MODAL_MAX_RETRIES) {
            modalRetryCount++;
            loadingEl.textContent = `Timed out. Retrying... (${modalRetryCount}/${MODAL_MAX_RETRIES})`;
            setTimeout(() => {
              requestInProgress = true;
              timeoutFired = false;
              loadStats(true);
            }, MODAL_RETRY_DELAY);
            return;
          }
          
          // Show error with manual retry option
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.innerHTML = 'Unable to load statistics. <button id="modal-retry-btn" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: var(--accent-primary); color: var(--bg-primary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Retry</button>';
          contentEl.style.display = 'none';
          
          // Add retry button handler
          const retryBtn = document.getElementById('modal-retry-btn');
          if (retryBtn) {
            retryBtn.onclick = () => {
              modalRetryCount = 0;
              errorEl.style.display = 'none';
              loadingEl.style.display = 'block';
              loadingEl.textContent = 'Loading...';
              loadStats();
            };
          }
        };
        
        apiTimeout = setTimeout(showTimeoutError, MODAL_TIMEOUT + 1000); // Slightly longer than fetch timeout
        
        try {
          // Create AbortController for this request
          currentRequestController = new AbortController();
          const controller = currentRequestController;
          
          // Create timeout promise (shorter timeout)
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              controller.abort();
              reject(new Error('Request timeout: API took too long to respond'));
            }, MODAL_TIMEOUT);
          });
          
          // Create fetch promise
          const fetchPromise = fetch(API_ENDPOINT, {
            signal: controller.signal,
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            },
            cache: 'no-cache',
            mode: 'cors',
            // Add keepalive to help with reliability
            keepalive: false,
          }).then(async (response) => {
            // Check if request was aborted
            if (controller.signal.aborted) {
              throw new Error('Request was aborted');
            }
            
            if (!response.ok) {
              const errorText = await response.text().catch(() => 'Unknown error');
              console.error('Stats API error:', response.status, errorText);
              throw new Error(`API returned ${response.status}: ${response.statusText}`);
            }
            
            // Add timeout for JSON parsing (shorter)
            const jsonTimeout = new Promise((_, reject) => {
              setTimeout(() => reject(new Error('JSON parsing timeout')), 1500);
            });
            
            const jsonPromise = response.json();
            const data = await Promise.race([jsonPromise, jsonTimeout]);
            
            return data;
          });
          
          // Race between fetch and timeout
          const data = await Promise.race([fetchPromise, timeoutPromise]);
          
          // Clear timeouts on success
          if (apiTimeout) {
            clearTimeout(apiTimeout);
            apiTimeout = null;
          }
          
          // Clear controller reference
          currentRequestController = null;
          requestInProgress = false;
          timeoutFired = false;
          modalRetryCount = 0;
          
          console.log('Stats loaded:', data);
          
          loadingEl.style.display = 'none';
          errorEl.style.display = 'none';
          contentEl.style.display = 'block';
          
          const totalViewsEl = document.getElementById('total-views');
          const distinctIPsEl = document.getElementById('distinct-ips');
          const uniqueVisitorsEl = document.getElementById('unique-visitors');
          const topPageEl = document.getElementById('top-page');
          
          if (totalViewsEl) totalViewsEl.textContent = data.totalViews || '0';
          if (distinctIPsEl) distinctIPsEl.textContent = data.distinctIPs || '0';
          if (uniqueVisitorsEl) uniqueVisitorsEl.textContent = data.uniqueVisitors || '0';
          if (topPageEl) topPageEl.textContent = data.topPage || 'N/A';
          
        } catch (error) {
          // Clear timeouts
          if (apiTimeout) {
            clearTimeout(apiTimeout);
            apiTimeout = null;
          }
          
          // Clear controller reference
          currentRequestController = null;
          requestInProgress = false;
          
          // Don't show error if timeout already fired
          if (timeoutFired) {
            console.error('Error loading stats (timeout already handled):', error);
            return;
          }
          
          // Try to retry if we haven't exceeded max retries
          if (modalRetryCount < MODAL_MAX_RETRIES) {
            modalRetryCount++;
            const errorMsg = error.name === 'AbortError' || error.message?.includes('timeout') 
              ? 'Request timed out' 
              : error.message || 'Network error';
            loadingEl.textContent = `${errorMsg}. Retrying... (${modalRetryCount}/${MODAL_MAX_RETRIES})`;
            setTimeout(() => {
              requestInProgress = true;
              timeoutFired = false;
              loadStats(true);
            }, MODAL_RETRY_DELAY);
            console.warn(`Modal stats load failed, retrying (${modalRetryCount}/${MODAL_MAX_RETRIES}):`, error);
            return;
          }
          
          // Max retries reached, show error with retry button
          console.error('Error loading stats after retries:', error);
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.innerHTML = 'Unable to load statistics. <button id="modal-retry-btn" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: var(--accent-primary); color: var(--bg-primary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Retry</button>';
          contentEl.style.display = 'none';
          
          // Add retry button handler
          const retryBtn = document.getElementById('modal-retry-btn');
          if (retryBtn) {
            retryBtn.onclick = () => {
              modalRetryCount = 0;
              errorEl.style.display = 'none';
              loadingEl.style.display = 'block';
              loadingEl.textContent = 'Loading...';
              loadStats();
            };
          }
        }
      };

      // Setup tooltip positioning for fixed overlay
      const setupTooltips = () => {
        const tooltips = document.querySelectorAll('.stat-label-tooltip');
        tooltips.forEach(tooltip => {
          const updatePosition = (e) => {
            const rect = tooltip.getBoundingClientRect();
            const left = rect.left + (rect.width / 2);
            const top = rect.top;
            
            // Set CSS custom properties for positioning
            tooltip.style.setProperty('--tooltip-left', `${left}px`);
            tooltip.style.setProperty('--tooltip-top', `${top}px`);
          };
          
          tooltip.addEventListener('mouseenter', updatePosition);
          tooltip.addEventListener('mousemove', updatePosition);
        });
      };

      infoBtn.addEventListener('click', () => {
        infoModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        // Reset retry count when opening modal
        modalRetryCount = 0;
        loadStats();
        // Setup tooltips after modal opens and stats load
        setTimeout(() => {
          setupTooltips();
        }, 500);
      });
      
      // Also reload stats when modal is reopened (in case it failed before)
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const isVisible = infoModal.style.display === 'block';
            if (isVisible && !document.getElementById('stats-content')?.style.display) {
              // Modal opened and stats not loaded, try loading
              const loadingEl = document.getElementById('stats-loading');
              const errorEl = document.getElementById('stats-error');
              if (loadingEl && errorEl && errorEl.style.display === 'block') {
                // Stats failed before, reset and try again
                modalRetryCount = 0;
                errorEl.style.display = 'none';
                loadingEl.style.display = 'block';
                loadingEl.textContent = 'Loading...';
                loadStats();
              }
            }
            // Setup tooltips when stats content becomes visible
            if (isVisible && document.getElementById('stats-content')?.style.display === 'block') {
              setTimeout(setupTooltips, 100);
            }
          }
        });
      });
      
      observer.observe(infoModal, { attributes: true, attributeFilter: ['style'] });
    }

    // Removed dual-scroll logic; native bottom scrollbars remain
  }
</script>
