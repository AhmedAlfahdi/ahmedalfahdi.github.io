---
// Visitor tracking component
// This component sends page view data to your analytics API
---

<script>
  if (typeof window !== 'undefined') {
    // Configuration - Update this with your API endpoint
    // In Astro, import.meta.env is available at build time for PUBLIC_* vars
    const API_BASE = import.meta.env.PUBLIC_ANALYTICS_API || 'https://analytics-api-one.vercel.app/api';
    const API_ENDPOINT = `${API_BASE}/track`;
    
    // Only track once per page load
    let tracked = false;
    
    const trackVisit = async () => {
      if (tracked) return;
      tracked = true;
      
      try {
        const pageData = {
          path: window.location.pathname,
          referrer: document.referrer || 'direct',
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString(),
          screenWidth: window.screen.width,
          screenHeight: window.screen.height,
          language: navigator.language,
        };
        
        // Debug logging
        console.log('Tracking visit to:', API_ENDPOINT);
        console.log('Page data:', pageData);
        
        // Send to API with error handling
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(pageData),
          mode: 'cors', // Explicitly set CORS mode
          keepalive: true,
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.warn('Analytics tracking failed:', response.status, response.statusText, errorText);
        } else {
          const result = await response.json();
          console.log('Visit tracked successfully:', result);
        }
      } catch (error) {
        // Log detailed error for debugging
        console.error('Analytics tracking error:', error);
        console.error('Error details:', {
          message: error.message,
          name: error.name,
          stack: error.stack,
          endpoint: API_ENDPOINT
        });
      }
    };
    
    // Track on page load
    if (document.readyState === 'complete') {
      trackVisit();
    } else {
      window.addEventListener('load', trackVisit);
    }
  }
</script>

