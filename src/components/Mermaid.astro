---
interface Props {
  chart: string;
}

const { chart } = Astro.props;
const containerId = `mermaid-container-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="mermaid-wrapper" id={containerId}>
  <div class="mermaid-controls">
    <button class="control-btn zoom-in" title="Zoom in" data-action="zoom-in">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
      </svg>
    </button>
    <button class="control-btn zoom-out" title="Zoom out" data-action="zoom-out">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
      </svg>
    </button>
    <button class="control-btn reset" title="Reset zoom" data-action="reset">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
      </svg>
    </button>
    <button class="control-btn fullscreen" title="Fullscreen" data-action="fullscreen">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
      </svg>
    </button>
  </div>
  <div class="mermaid-container">
    <div class="mermaid-viewport">
      <pre class="mermaid">{chart.trim()}</pre>
    </div>
  </div>
</div>

<script define:vars={{ containerId }}>
  const wrapper = document.getElementById(containerId);
  if (!wrapper) return;
  
  const viewport = wrapper.querySelector('.mermaid-viewport');
  const container = wrapper.querySelector('.mermaid-container');
  if (!viewport || !container) return;
  
  // Ensure mermaid renders if it hasn't already (for dynamically loaded content)
  const mermaidElement = wrapper.querySelector('.mermaid');
  if (mermaidElement && window.mermaid) {
    const checkRender = () => {
      if (!mermaidElement.querySelector('svg')) {
        window.mermaid.run({
          nodes: [mermaidElement],
        }).catch((err) => {
          console.error('Mermaid render error:', err);
        });
      }
    };
    
    // Try after a short delay to let auto-render happen first
    setTimeout(checkRender, 200);
  }
  
  let scale = 1;
  let panning = false;
  let startX = 0;
  let startY = 0;
  let translateX = 0;
  let translateY = 0;
  
  function updateTransform() {
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
  }
  
  // Control buttons
  wrapper.querySelectorAll('.control-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const action = e.currentTarget.getAttribute('data-action');
      
      switch(action) {
        case 'zoom-in':
          scale = Math.min(scale * 1.2, 5);
          updateTransform();
          break;
        case 'zoom-out':
          scale = Math.max(scale / 1.2, 0.5);
          updateTransform();
          break;
        case 'reset':
          scale = 1;
          translateX = 0;
          translateY = 0;
          updateTransform();
          break;
        case 'fullscreen':
          if (!document.fullscreenElement) {
            wrapper.requestFullscreen().catch(err => {
              console.log('Fullscreen not supported');
            });
          } else {
            document.exitFullscreen();
          }
          break;
      }
    });
  });
  
  // Mouse wheel zoom
  container.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    scale = Math.max(0.5, Math.min(5, scale * delta));
    updateTransform();
  }, { passive: false });
  
  // Pan with mouse drag
  container.addEventListener('mousedown', (e) => {
    if (e.button === 0) {
      panning = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
      container.style.cursor = 'grabbing';
    }
  });
  
  document.addEventListener('mousemove', (e) => {
    if (panning) {
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      updateTransform();
    }
  });
  
  document.addEventListener('mouseup', () => {
    if (panning) {
      panning = false;
      container.style.cursor = 'grab';
    }
  });
  
  // Set initial cursor
  container.style.cursor = 'grab';
</script>

<style>
  .mermaid-wrapper {
    position: relative;
    background: var(--bg-tertiary);
    border-radius: 8px;
    margin: 2rem 0;
    border: 1px solid var(--border-strong);
    overflow: hidden;
  }
  
  .mermaid-wrapper:fullscreen {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
    border: none;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
  }
  
  .mermaid-wrapper:-webkit-full-screen {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
    border: none;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
  }
  
  .mermaid-wrapper:-moz-full-screen {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
    border: none;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
  }
  
  .mermaid-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
    z-index: 10;
    background: rgba(22, 31, 41, 0.95);
    backdrop-filter: blur(10px);
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border-strong);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  .control-btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-strong);
    border-radius: 4px;
    padding: 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: var(--text-primary);
  }
  
  .control-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }
  
  .control-btn:active {
    background: var(--bg-primary);
  }

  .mermaid-container {
    padding: 2rem;
    overflow: hidden;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    background: var(--bg-tertiary);
  }
  
  .mermaid-wrapper:fullscreen .mermaid-container,
  .mermaid-wrapper:-webkit-full-screen .mermaid-container,
  .mermaid-wrapper:-moz-full-screen .mermaid-container {
    width: 100%;
    height: 100%;
    min-height: 100vh;
    background: var(--bg-primary);
  }
  
  .mermaid-viewport {
    transform-origin: center center;
    transition: transform 0.2s ease-out;
  }

  .mermaid {
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
    font-family: var(--font-mono);
  }

  :global(.mermaid svg) {
    max-width: 100%;
    height: auto;
    display: block;
  }

  /* Override Mermaid text colors for better visibility */
  :global(.mermaid .nodeLabel),
  :global(.mermaid .edgeLabel),
  :global(.mermaid .cluster-label) {
    color: var(--text-primary) !important;
    fill: var(--text-primary) !important;
  }

  :global(.mermaid .node rect),
  :global(.mermaid .node circle),
  :global(.mermaid .node ellipse) {
    fill: var(--bg-secondary) !important;
    stroke: var(--border-strong) !important;
  }

  :global(.mermaid .edgePath .path) {
    stroke: var(--accent-secondary) !important;
  }

  :global(.mermaid .arrowheadPath) {
    fill: var(--accent-secondary) !important;
    stroke: var(--accent-secondary) !important;
  }

  :global(.mermaid .cluster rect) {
    fill: var(--bg-primary) !important;
    stroke: var(--border-strong) !important;
  }
</style>

